<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Edge Functions to Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #3ECF8E;
        }
        .function-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .function-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .function-description {
            margin-bottom: 15px;
        }
        .deploy-button {
            background-color: #3ECF8E;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .deploy-button:hover {
            background-color: #2EAF6E;
        }
        .status {
            margin-top: 10px;
            font-style: italic;
        }
        .success {
            color: #3ECF8E;
        }
        .error {
            color: #CF3E3E;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-top: 10px;
            font-family: monospace;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .instructions {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Deploy Edge Functions to Supabase</h1>
    
    <div class="instructions">
        <h2>Instructions</h2>
        <p>This tool helps you deploy edge functions to your Supabase project. Follow these steps:</p>
        <ol>
            <li>Open the Supabase dashboard in another tab: <a href="https://app.supabase.com/project/twttyqbqhlgyzntcblbz/functions" target="_blank">Supabase Edge Functions</a></li>
            <li>For each function below, click "Deploy" to copy the code to your clipboard</li>
            <li>In the Supabase dashboard, click "Create a new function"</li>
            <li>Enter the function name as shown below</li>
            <li>Set "Verify JWT" to true</li>
            <li>Paste the code from your clipboard</li>
            <li>Click "Create"</li>
            <li>Mark the function as deployed in this tool</li>
        </ol>
    </div>

    <h2>Edge Functions to Deploy</h2>
    
    <div id="functions-container">
        <!-- Functions will be loaded here -->
        <p>Loading functions...</p>
    </div>

    <script>
        // Function descriptions
        const functionDescriptions = {
            "add_commission_approval_comment": "Adds a comment to a commission approval. Used by admins and agents to communicate about commission approvals.",
            "create_notification": "Creates a notification for a user. Used for system notifications and alerts.",
            "delete_commission_approval_comment": "Deletes a comment from a commission approval. Used by admins and agents to manage comments.",
            "delete_notification": "Deletes a notification. Used by users to clear notifications.",
            "generate_commission_forecast": "Generates a forecast of future commission payments. Used by agents to plan their finances.",
            "generate_commission_installments": "Generates installment payments for a commission. Used when a new transaction is created.",
            "generate_installments_on_approval": "Generates installment payments when a commission is approved. Used by admins when approving commissions.",
            "get_agent_profile": "Gets the profile of the current agent. Used for displaying agent information.",
            "get_approval_status_counts": "Gets counts of approvals by status. Used for dashboard statistics.",
            "get_approved_commission_total": "Gets the total amount of approved commissions. Used for dashboard statistics.",
            "get_commission_approvals": "Gets a list of commission approvals. Used by admins to review approvals.",
            "get_commission_approval_comments": "Gets comments for a commission approval. Used in the approval detail view.",
            "get_commission_approval_detail": "Gets detailed information about a commission approval. Used in the approval detail view.",
            "get_commission_approval_history": "Gets the history of a commission approval. Used to track changes to an approval.",
            "get_pending_commission_total": "Gets the total amount of pending commissions. Used for dashboard statistics.",
            "get_user_notifications": "Gets notifications for the current user. Used in the notifications panel.",
            "mark_all_notifications_read": "Marks all notifications as read. Used in the notifications panel.",
            "mark_notification_read": "Marks a single notification as read. Used in the notifications panel.",
            "send-agent-invitation": "Sends an invitation to a new agent. Used by admins to invite new agents.",
            "update_commission_approval_status": "Updates the status of a commission approval. Used by admins to approve or reject commissions."
        };

        // Function to load the functions
        async function loadFunctions() {
            try {
                const response = await fetch('./edge_functions_to_deploy');
                if (!response.ok) {
                    throw new Error('Failed to load functions');
                }
                
                // This would normally parse the directory listing, but we'll hardcode it for now
                const functions = [
                    "add_commission_approval_comment",
                    "create_notification",
                    "delete_commission_approval_comment",
                    "delete_notification",
                    "generate_commission_forecast",
                    "generate_commission_installments",
                    "generate_installments_on_approval",
                    "get_agent_profile",
                    "get_approval_status_counts",
                    "get_approved_commission_total",
                    "get_commission_approvals",
                    "get_commission_approval_comments",
                    "get_commission_approval_detail",
                    "get_commission_approval_history",
                    "get_pending_commission_total",
                    "get_user_notifications",
                    "mark_all_notifications_read",
                    "mark_notification_read",
                    "send-agent-invitation",
                    "update_commission_approval_status"
                ];
                
                const container = document.getElementById('functions-container');
                container.innerHTML = '';
                
                for (const func of functions) {
                    const card = document.createElement('div');
                    card.className = 'function-card';
                    card.id = `function-${func}`;
                    
                    const nameElement = document.createElement('div');
                    nameElement.className = 'function-name';
                    nameElement.textContent = func;
                    
                    const descriptionElement = document.createElement('div');
                    descriptionElement.className = 'function-description';
                    descriptionElement.textContent = functionDescriptions[func] || 'No description available';
                    
                    const codeArea = document.createElement('textarea');
                    codeArea.id = `code-${func}`;
                    codeArea.readOnly = true;
                    
                    const deployButton = document.createElement('button');
                    deployButton.className = 'deploy-button';
                    deployButton.textContent = 'Copy Code & Deploy';
                    deployButton.onclick = () => deployFunction(func);
                    
                    const markDeployedButton = document.createElement('button');
                    markDeployedButton.className = 'deploy-button';
                    markDeployedButton.style.backgroundColor = '#4A6FA5';
                    markDeployedButton.textContent = 'Mark as Deployed';
                    markDeployedButton.onclick = () => markAsDeployed(func);
                    
                    const statusElement = document.createElement('div');
                    statusElement.className = 'status';
                    statusElement.id = `status-${func}`;
                    
                    card.appendChild(nameElement);
                    card.appendChild(descriptionElement);
                    card.appendChild(codeArea);
                    card.appendChild(document.createElement('br'));
                    card.appendChild(document.createElement('br'));
                    card.appendChild(deployButton);
                    card.appendChild(document.createTextNode(' '));
                    card.appendChild(markDeployedButton);
                    card.appendChild(statusElement);
                    
                    container.appendChild(card);
                    
                    // Load the function code
                    loadFunctionCode(func);
                }
            } catch (error) {
                console.error('Error loading functions:', error);
                document.getElementById('functions-container').innerHTML = `<p class="error">Error loading functions: ${error.message}</p>`;
            }
        }
        
        // Function to load the code for a function
        async function loadFunctionCode(func) {
            try {
                const response = await fetch(`./edge_functions_to_deploy/${func}.ts`);
                if (!response.ok) {
                    throw new Error('Failed to load function code');
                }
                
                const code = await response.text();
                document.getElementById(`code-${func}`).value = code;
            } catch (error) {
                console.error(`Error loading code for ${func}:`, error);
                document.getElementById(`code-${func}`).value = `Error loading code: ${error.message}`;
            }
        }
        
        // Function to deploy a function
        function deployFunction(func) {
            const codeElement = document.getElementById(`code-${func}`);
            const statusElement = document.getElementById(`status-${func}`);
            
            // Copy the code to clipboard
            codeElement.select();
            document.execCommand('copy');
            
            statusElement.textContent = 'Code copied to clipboard! Now create the function in Supabase.';
            statusElement.className = 'status success';
            
            // Open the Supabase dashboard
            window.open('https://app.supabase.com/project/twttyqbqhlgyzntcblbz/functions', '_blank');
        }
        
        // Function to mark a function as deployed
        function markAsDeployed(func) {
            const card = document.getElementById(`function-${func}`);
            const statusElement = document.getElementById(`status-${func}`);
            
            card.style.backgroundColor = '#E6F7EF';
            statusElement.textContent = 'Marked as deployed!';
            statusElement.className = 'status success';
            
            // Save the deployed status in localStorage
            const deployedFunctions = JSON.parse(localStorage.getItem('deployedFunctions') || '[]');
            if (!deployedFunctions.includes(func)) {
                deployedFunctions.push(func);
                localStorage.setItem('deployedFunctions', JSON.stringify(deployedFunctions));
            }
        }
        
        // Load the functions when the page loads
        window.onload = () => {
            loadFunctions();
            
            // Check for previously deployed functions
            const deployedFunctions = JSON.parse(localStorage.getItem('deployedFunctions') || '[]');
            for (const func of deployedFunctions) {
                setTimeout(() => {
                    const card = document.getElementById(`function-${func}`);
                    const statusElement = document.getElementById(`status-${func}`);
                    
                    if (card && statusElement) {
                        card.style.backgroundColor = '#E6F7EF';
                        statusElement.textContent = 'Previously deployed';
                        statusElement.className = 'status success';
                    }
                }, 1000); // Delay to ensure elements are loaded
            }
        };
    </script>
</body>
</html>
